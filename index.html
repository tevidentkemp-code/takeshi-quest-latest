<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shateki Quest Scorer</title>

<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0f1220;--card:#171a2b;--ink:#e7e9f5;--muted:#a8acc3;--accent:#7bdcff;--accent-2:#8cff9e;
    --danger:#ff6b6b;--warn:#ffcc66;--good:#7fffd4;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:14px;
    --pad-h:148px; --left-col-w:96px; --start-btn-h:52px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; min-height:100dvh; overflow-x:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
    background:radial-gradient(1000px 600px at 0% 0%,#1b1f36 0%,#0f1220 45%,#0b0e1a 100%); color:var(--ink);
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }
 .wrap{max-width:1100px;margin-inline:auto;padding:16px; padding-bottom:calc(var(--pad-h) + 16px)}
.start-actions{
  display:flex;
  flex-direction:column;
  align-items:center;
  margin:0 auto;
  text-align:center;
  max-width:480px; 
}

.start-actions .btn.big{
  width:100%;
}

.section{
  margin:14px 0;
  padding:14px;
}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .column{display:flex;flex-direction:column;gap:10px}
  .grow{flex:1}
  .hidden{display:none!important}
  .tag{font-size:.78rem;color:var(--muted);padding:.15rem .45rem;border:1px solid #2b3050;border-radius:999px}
  .banner{background:linear-gradient(180deg,#14284a,#12213d);border:1px solid #2a4777;border-radius:12px;padding:12px;margin-top:10px}

  input[type="text"],select,input[type="password"]{
    background:#101329;border:1px solid #2b3050;color:var(--ink);padding:.65rem .8rem;border-radius:10px;outline:none;width:100%
  }
  .btn{appearance:none;border:1px solid #2b3050;border-radius:12px;background:#131733;color:var(--ink);
       padding:.7rem 1rem;cursor:pointer;transition:.15s transform,.15s background,.15s border-color,.15s opacity;font-weight:700}
  .btn:hover{transform:translateY(-1px);background:#161a3a}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
  .btn.primary{background:linear-gradient(180deg,#1d255a,#19214f);border-color:#32407a}
  .btn.good{background:linear-gradient(180deg,#1b3d2e,#183628);border-color:#2e6a4f}
  .btn.warn{background:linear-gradient(180deg,#3a3219,#2f2914);border-color:#6b5821}
  .btn.danger{background:linear-gradient(180deg,#47212a,#3c1b23);border-color:#7a2e3f}
  .btn.big{font-size:1.15rem;padding:1rem 1.25rem;border-radius:14px}
  .btn.small { padding: 4px 8px; font-size: 0.8rem; min-width: 30px; min-height: 24px; }

  /* Tables */
  .table-wrap{overflow:auto;border-radius:12px;border:1px solid #2a2e48}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#0f1329;table-layout:fixed}
  thead th{
    background:#14183a;border-bottom:1px solid #2a2e48;padding:.6rem .5rem;text-align:left;font-weight:700;
    position:sticky; top:0; z-index:5;
  }
  #scoreWrap thead th:first-child{width:var(--left-col-w);min-width:var(--left-col-w);max-width:var(--left-col-w)}
  #scoreWrap tbody th{width:var(--left-col-w);min-width:var(--left-col-w);max-width:var(--left-col-w);
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:6px}
  thead th.player, tbody td.player{min-width:120px; text-align:center}
  tbody td,tbody th{padding:.55rem .5rem;border-bottom:1px dashed #23284a;text-align:left;vertical-align:middle}
  tbody td{white-space:nowrap; overflow:hidden; text-overflow:clip}
  tbody tr:last-child td{border-bottom:none}
  tbody th{font-weight:600;color:#cfd3ee;background:#101533;border-right:1px solid #22264a}
  .num{font-variant-numeric:tabular-nums}
  .center{text-align:center}
  .current-cell{background:linear-gradient(180deg,#1e2450,#171d45)!important;box-shadow:inset 0 0 0 1px #4050a7}
  .current-col{background:rgba(64,80,167,.07)}

  /* Header content */
  thead th .th-wrap{display:flex;flex-direction:column;align-items:center;gap:2px}
  thead th .th-name{font-weight:800;letter-spacing:.02em}
  thead th .th-beers{font-size:12px;line-height:1;min-height:14px;letter-spacing:.5px;filter:drop-shadow(0 0 6px rgba(255,204,102,.35)); text-align:center}
  .th-throw-arrow{font-size:13px; line-height:1}
  .th-total{font-weight:800;letter-spacing:.02em}
  .th-diff{font-size:10px; line-height:1; font-weight:400 !important; color:var(--muted); text-align:center}
  .th-diff-label{font-size:11px; font-weight:400 !important; color:var(--muted)}

  /* Score cell */
  .cell-wrap{display:inline-flex;flex-direction:column;align-items:center;gap:1px;line-height:1}
  .cell-main{font-weight:800;line-height:1.1}
  .cell-sub{color:var(--muted);font-size:.60em;font-weight:500;opacity:.95;letter-spacing:-0.01em;line-height:1}
  .sub-win{color:var(--accent-2)!important;font-weight:700}

  /* Stats (kept for layout sync; shown via modals) */
  .stats-box{display:none}
  #statsWrap thead th:first-child,
  #mstatsWrap thead th:first-child{width:var(--left-col-w);min-width:var(--left-col-w);max-width:var(--left-col-w)}
  #statsWrap tbody th.stats-th,
  #mstatsWrap tbody th.stats-th{width:var(--left-col-w);min-width:var(--left-col-w);max-width:var(--left-col-w);
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:8px}
  .stats-th{background:#101533;color:#cfd3ee}
  .stats-row th,.stats-row td{font-size:.86rem;line-height:1.15;padding:.45rem .5rem}
  .stats-row td{color:#e1e4fb}

  /* Floating names header */
  .float-head{position:sticky; top:0; z-index:200000;
    background:rgba(17,19,38,.96); backdrop-filter:blur(6px);
    border:1px solid #2a2e48; border-radius:12px; margin-bottom:10px}
  .float-head .table-wrap{border:none;border-radius:12px}
  #floatWrap thead th:first-child{width:var(--left-col-w);min-width:var(--left-col-w);max-width:var(--left-col-w)}

  /* Hide Throw Pad off non-game pages */
  body[data-page="details"] .pad-bar,
  body[data-page="players"] .pad-bar,
  body[data-page="leaderboard"] .pad-bar.hidden { display:none; }
  body[data-page="game"] .pad-bar { display:block; }

  /* Fixed Throw Pad */
  .pad-bar{position:fixed;left:0;right:0;bottom:0;background:rgba(17,19,38,.96);backdrop-filter:blur(6px);
    border-top:1px solid #23284a;z-index:100000;padding-bottom:max(8px, env(safe-area-inset-bottom))}
  .pad-inner{max-width:1100px;margin:0 auto;padding:8px 12px}
  .pad-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px}
  .pad-left{display:flex;align-items:center;gap:10px}
  .pad-hint{color:#a8acc3;font-size:.82rem}
  .pad{display:flex;flex-wrap:wrap;gap:6px;max-height:114px;overflow:auto;align-items:flex-start}
  .pad .btn{min-width:52px;min-height:38px}
  .pad-spacer{flex:1 1 auto}

  /* Modal */
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:400000}
  .modal{background:#0f1329; border:1px solid #2a2e48; border-radius:14px; box-shadow:var(--shadow); padding:12px; width:92%; max-width:640px}
  .modal h3{ margin:0 0 8px 0; font-size:1.02rem }
  .modal-body{ max-height:60vh; overflow:auto; padding-right:2px; }
  .modal-footer{ margin-top:10px; display:flex; gap:8px; }
  .hs-table{ width:100%; border-collapse:separate; border-spacing:0 }
  .hs-table th, .hs-table td{ padding:.5rem .5rem; border-bottom:1px dashed #23284a; }
  .hs-table th{ text-align:left; color:#cfd3ee; }

  /* Add / Select Player Modals */
  #addPlayerModal.hidden, #selectPlayerModal.hidden, #adminHubModal.hidden, #savedPlayersAdminModal.hidden { display:none; }

  /* Compact admin tables */
  .compact * { font-size: 12px !important; }
  .compact .btn { padding: 4px 8px; font-weight: 600; }
  .compact table th, .compact table td { padding: .35rem .4rem; }
  
  /* Cloud status pill (bottom-right) */
.cloud-status {
  position: fixed;
  right: 12px;
  bottom: 12px;
  background: rgba(10, 12, 30, .92);
  border: 1px solid #2b3050;
  color: var(--muted);
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 500000;
  pointer-events: none;
}

.cloud-status .cloud-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #666;
}

/* States */
.cloud-status.checking .cloud-dot { background: var(--warn); }
.cloud-status.ok       .cloud-dot { background: var(--accent-2); }
.cloud-status.error    .cloud-dot { background: var(--danger); }
  
</style>
</head>
<body data-page="details">
  <div class="wrap">

    <!-- PAGE 1: GAME DETAILS -->
    <section id="details" class="card section">
      <h2>Game Details</h2>

      <div class="start-actions column" style="gap:8px; max-width:480px">
        <button id="questBtn" class="btn primary big" type="button">New game ‚ñ∂</button>
        <button id="resumeBtn" class="btn good big" type="button" disabled title="No saved match">Resume game ‚ñ∂</button>

        <div class="row" style="justify-content:center; gap:8px; flex-wrap:wrap; margin-top:4px;">
          <button id="hsMenuBtn" class="btn" type="button">High Scores (League)</button>
          <button id="playerStatsBtn" class="btn" type="button">Player Stats</button>
          <button id="hsMenuBtnSP" class="btn" type="button">High Scores (Practice)</button>
        </div>
      </div>

      <!-- Single Admin Code row -->
      <div class="row" id="adminCodeRow" style="margin-top:16px;">
        <div class="grow" style="max-width:360px">
          <input id="adminCode" placeholder="Admin Code" />
        </div>
        <button id="adminEnterBtn" class="btn" type="button">Enter</button>
      </div>
    </section>

    <!-- PAGE 2: PLAYER SELECT -->
    <section id="players" class="card section hidden">
      <div class="row" style="position: relative; height: 40px;">
        <button class="btn" style="position: absolute; top: 0; left: 0;" id="backToDetailsBtn">‚Üê Game Details</button>
      </div>

      <h2>Player Select</h2>

      <div class="row" style="max-width:640px">
        <div class="column" style="flex:1; min-width:220px">
          <label class="tag" for="psNumGames">Number of games</label>
          <select id="psNumGames">
            <option value="1">1 game</option><option value="2">2 games</option><option value="3">3 games</option>
            <option value="4">4 games</option><option value="5" selected>5 games</option>
          </select>
        </div>
        <div class="column" style="flex:1; min-width:220px">
          <label class="tag" for="psNumPlayers">Number of players</label>
          <select id="psNumPlayers">
            <option value="1">1 player (Training)</option>
            <option value="2" selected>2 players</option>
            <option value="3">3 players</option>
            <option value="4">4 players</option>
            <option value="5">5 players</option>
            <option value="6">6 players</option>
          </select>
        </div>
      </div>

      <div id="psPlayerFields" class="column" style="margin-top:12px">
        <!-- Rows injected -->
      </div>

      <div class="row" style="margin-top:12px">
        <button id="startMatchBtn" class="btn primary big" type="button">Start Match ‚ñ∂</button>
      </div>
    </section>

    <!--PAGE3: GAME -->
    <section id="game" class="hidden">
      <div class="card section">
        <div class="row" style="position: relative; height: 40px;">
          <button id="startScreenBtn" class="btn" style="position: absolute; top: 0; left: 0;">Start Screen</button>
          <button id="restartGameBtn" class="btn" style="position: absolute; top: 0; left: 110px;">Restart Game</button>
        </div>

        <div class="row" id="topControls">
          <div class="tag">Match <b id="matchLabel">‚Äì</b></div>
          <div class="tag" id="roundTag">Round <b id="roundLabel">‚Äì</b></div>
          <div class="tag">Player <b id="turnLabel">‚Äì</b></div>
          <div class="tag" id="dartTag">Dart <b id="dartLabel">‚Äì</b></div>
          <span class="grow"></span>
        </div>

        <!-- Floating names + wins + totals -->
        <div class="float-head" id="floatHead">
          <div class="table-wrap" id="floatWrap">
            <table aria-hidden="true"><thead id="floatThead"></thead></table>
          </div>
        </div>

        <!-- Scoreboard -->
        <div class="table-wrap" id="scoreWrap" style="margin-top:10px">
          <table aria-label="Scoreboard">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <!-- Hidden stats tables used to keep column widths aligned -->
        <div class="stats-box">
          <div class="table-wrap" id="statsWrap">
            <table aria-label="Player statistics">
              <thead id="statsThead"></thead>
              <tbody id="statsTbody"></tbody>
            </table>
          </div>
        </div>
        <div class="stats-box">
          <div class="table-wrap" id="mstatsWrap">
            <table aria-label="Match statistics">
              <thead id="mstatsThead"></thead>
              <tbody id="mstatsTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="endBanner" class="banner hidden"></div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="leaderboard" class="card section hidden">
      <div class="row" style="position: relative; height: 40px;">
        <button id="startScreenBtnLB" class="btn" style="position: absolute; top: 0; left: 0;">Start Screen</button>
        <button id="restartGameBtnLB" class="btn" style="position: absolute; top: 0; left: 110px;">Restart Game</button>
      </div>
      <h2>Leaderboard</h2>
      <p class="tag"><span id="lbMatchInfo"></span></p>

      <div class="table-wrap" style="margin-top:8px">
        <table id="lbTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="nextGameBtn" class="btn primary big" type="button">Next game ‚ñ∂</button>
        <span class="grow"></span>
        <button id="gameScoresBtn" class="btn" type="button">Game Scores</button>
        <button id="newMatchBtn" class="btn danger" type="button">üóë END MATCH</button>
        <span id="gamesRemainTag" class="tag"></span>
      </div>
    </section>
  </div>

  <!-- Fixed Throw Pad (Game Stats / Match Stats / High Scores / Race appear here) -->
  <div class="pad-bar" id="padBar">
    <div class="pad-inner">
      <div class="pad-head">
        <div class="pad-left">
          <strong>Throw Pad</strong>
          <div id="padHint" class="pad-hint"></div>
        </div>
      </div>
      <div id="pad" class="pad"></div>
    </div>
  </div>

 <!-- Add Player Modal -->
<div id="addPlayerModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Add New Player</h3>
    <div class="modal-body">
      <div class="stack">
        <label class="tag" for="newPlayerName">Player Name</label>
        <input id="newPlayerName" type="text" placeholder="Enter player name" />
      </div>
      <div class="stack" style="margin-top: 15px;">
        <label class="tag" for="newPlayerPassword">Password</label>
        <input id="newPlayerPassword" type="password" placeholder="Enter password" />
      </div>
    </div>
    <div class="modal-footer">
      <button id="cancelAddPlayerBtn" class="btn" type="button">Cancel</button>
      <button id="savePlayerBtn" class="btn primary" type="button">Save Player</button>
    </div>
  </div>
</div>
  <!-- Select Player Modal -->
  <div id="selectPlayerModal" class="modal-backdrop hidden">
    <div class="modal">
      <h3>Select Player</h3>
      <div class="modal-body">
        <div class="stack">
          <label class="tag">Player Name</label>
          <select id="existingPlayerSelect" style="width: 100%;">
            <option value="">Select a saved player...</option>
          </select>
        </div>
        <div class="stack" style="margin-top: 15px;">
          <label class="tag" for="playerPassword">Password</label>
          <input id="playerPassword" type="password" placeholder="Enter password" />
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelSelectPlayerBtn" class="btn" type="button">Cancel</button>
        <button id="confirmSelectPlayerBtn" class="btn primary" type="button">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Admin Hub Modal -->
  <div id="adminHubModal" class="modal-backdrop hidden">
    <div class="modal">
      <h3>Admin Hub</h3>
      <div class="modal-body">
        <div class="row">
          <button id="openHsLeagueAdmin" class="btn">League High Scores Admin</button>
          <button id="openHsPracticeAdmin" class="btn">Practice High Scores Admin</button>
          <button id="openSavedPlayersAdmin" class="btn">Saved Players Admin</button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="closeAdminHubBtn" class="btn" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Saved Players Admin Modal -->
  <div id="savedPlayersAdminModal" class="modal-backdrop hidden">
    <div class="modal compact">
      <h3>Saved Players Admin</h3>
      <div class="modal-body">
        <div id="savedPlayersAdminBody"></div>
      </div>
      <div class="modal-footer">
        <button id="closeSavedPlayersAdminBtn" class="btn" type="button">Close</button>
      </div>
    </div>
  </div>
  <div id="cloudStatus" class="cloud-status checking">
  <span class="cloud-dot"></span>
  <span id="cloudStatusText">Checking cloud‚Ä¶</span>
</div>
</body>
</html>
<script>
/**********************
 * CONFIG: Supabase
 **********************/
const SUPABASE_URL = "https://vvfqumgtasuacpggdmxx.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2ZnF1bWd0YXN1YWNwZ2dkbXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTk0MDMsImV4cCI6MjA3ODUzNTQwM30.8NblWOwEsY1FP1hxvO6isQ908NyxkTgntnZZiXIFPHE";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const TABLE_PLAYERS = "players";
const TABLE_HS_LEAGUE = "high_scores";
const TABLE_HS_PRACTICE = "high_scores_sp";

/**********************
 * SAFETY + TOAST
 **********************/
(function(){
  window.addEventListener('error', function(e){
    var b=document.getElementById('__err_banner')||document.createElement('div');
    b.id='__err_banner';
    b.style.cssText='position:fixed;left:0;right:0;top:0;background:#7a2e3f;color:#fff;padding:8px 12px;z-index:999999;font-weight:800';
    b.textContent='JS error: ' + (e.message||'(open console)');
    document.body.appendChild(b);
  });
  if(!window.toast){
    window.toast=function(msg){
      var d=document.createElement('div');
      d.textContent=msg;
      d.style.cssText='position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#121735;border:1px solid #2b3050;color:#e7e9f5;padding:8px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:110000';
      document.body.appendChild(d); setTimeout(function(){d.remove();},1700);
    };
  }
})();

/*****************
 * CORE HELPERS
 *****************/
const byId = id => document.getElementById(id);
const STORAGE_KEY='shateki_quest_scorer_v6';
const HS_KEY='shateki_quest_highscores_v1';       // kept for backward-compat local
const HS_KEY_SP='shateki_quest_highscores_sp_v1'; // kept for backward-compat local
const safeSave=(k,o)=>{try{localStorage.setItem(k,JSON.stringify(o));}catch(e){}};
const safeLoad=k=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):null;}catch(e){return null;}};
const safeClear=k=>{try{localStorage.removeItem(k);}catch(e){}};

const COLOR_PALETTE=['#7bdcff','#8cff9e','#ffcc66','#ff9bd6','#f8d66d','#a6b3ff','#7fffd4','#ffb27b','#ffd166','#06d6a0','#118ab2','#ef476f'];
function assignUniqueColors(arr){ for(let i=0;i<arr.length;i++){ arr[i].color = COLOR_PALETTE[i % COLOR_PALETTE.length]; } }

// Cloud status indicator
const cloudStatusEl     = byId('cloudStatus');
const cloudStatusTextEl = byId('cloudStatusText');

function setCloudStatus(mode, text) {
  if (!cloudStatusEl || !cloudStatusTextEl) return;
  cloudStatusEl.classList.remove('ok', 'error', 'checking');
  cloudStatusEl.classList.add(mode);
  cloudStatusTextEl.textContent = text;
}

function markCloudOk() {
  setCloudStatus('ok', 'Cloud: connected');
}

function markCloudError(err) {
  console.error('[Supabase]', err);
  setCloudStatus('error', 'Cloud: problem ‚Äì using local');
}
function addPadUtilityButtons() {
  const spacer = document.createElement('span');
  spacer.className = 'pad-spacer';
  pad.appendChild(spacer);

  const gameStatsBtn = document.createElement('button');
  gameStatsBtn.className = 'btn';
  gameStatsBtn.textContent = 'Game Stats';
  gameStatsBtn.onclick = openGameStatsDialog;

  const matchStatsBtn = document.createElement('button');
  matchStatsBtn.className = 'btn';
  matchStatsBtn.textContent = 'Match Stats';
  matchStatsBtn.onclick = openMatchStatsDialog;

  const hsBtn = document.createElement('button');
  hsBtn.className = 'btn good';
  hsBtn.textContent = 'High Scores';
  hsBtn.onclick = openHighScoresDialog;

  const raceBtn = document.createElement('button');
  raceBtn.className = 'btn warn';
  raceBtn.textContent = 'Race';
  raceBtn.onclick = openGameRaceDialog;

  pad.append(gameStatsBtn, matchStatsBtn, hsBtn, raceBtn);
}

function show(id){
  ['details','players','game','leaderboard'].forEach(x=>byId(x)?.classList.add('hidden'));
  byId(id)?.classList.remove('hidden');
  document.body.setAttribute('data-page', id);
  updatePadSpacer();
  const fh=byId('floatHead');
  if(fh) fh.classList.toggle('hidden', id!=='game');
  buildPad();
}
const padBar = byId('padBar');
function updatePadSpacer(){ try{ const h=padBar?padBar.getBoundingClientRect().height:148; document.documentElement.style.setProperty('--pad-h', h+'px'); }catch(e){} }
addEventListener('resize',updatePadSpacer,{passive:true}); addEventListener('orientationchange',updatePadSpacer,{passive:true});

/*****************
 * GAME & STATE
 *****************/
const ROUNDS = (()=>{ const a=[]; for(let i=0;i<11;i++) a.push({type:'number',target:10+i}); a.push({type:'doubles'},{type:'triples'},{type:'bull'}); return a; })();
const MAX_ROUNDS=ROUNDS.length;
const state={ players:[], score:[], currentRound:0,currentPlayer:0,currentDart:0, history:[], finished:false, suddenDeath:{active:false, participants:[], turnIndex:0, throws:[], round:1}, match:{ totalGames:5, gameNumber:1, wins:[], history:[] }, matchAgg:null };
const totalScoreForPlayer = i => (state.score[i]||[]).reduce((s,row)=>s+(row?.roundTotal||0),0);
const save=()=>safeSave(STORAGE_KEY,state);
function ensureMatchAgg(){ if(state.matchAgg && state.matchAgg.hits) return; state.matchAgg={ hits:Array.from({length:state.players.length},()=>({})), totals60:Array.from({length:state.players.length},()=>0), totals100:Array.from({length:state.players.length},()=>0), totals140:Array.from({length:state.players.length},()=>0) }; }

/*****************
 * SUPABASE HELPERS
 *****************/
// simple SHA-256 hex for demo auth (client-side)
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

// PLAYERS
async function cloudListPlayers(){
  const { data, error } = await sb.from(TABLE_PLAYERS).select('name').order('name');
  if (error) {
    markCloudError(error);
    throw error;
  }
  markCloudOk();
  return data || [];
}

async function cloudCreatePlayer(name, password){
  const password_hash = await sha256Hex(password);
  const { error } = await sb.from(TABLE_PLAYERS).upsert({ name, password_hash }, { onConflict: 'name' });
  if (error) {
    markCloudError(error);
    throw error;
  }
  markCloudOk();
}

async function cloudValidatePlayer(name, password){
  const hash = await sha256Hex(password);
  const { data, error } = await sb.from(TABLE_PLAYERS)
    .select('name, password_hash')
    .eq('name', name)
    .maybeSingle();
  if (error) {
    markCloudError(error);
    throw error;
  }
  markCloudOk();
  if (!data) return false;
  return data.password_hash === hash;
}

async function cloudDeletePlayer(name){
  const { error } = await sb.from(TABLE_PLAYERS).delete().eq('name', name);
  if (error) {
    markCloudError(error);
    throw error;
  }
  markCloudOk();
}

async function cloudUpdatePlayerPassword(name, newPassword){
  const password_hash = await sha256Hex(newPassword);
  const { error } = await sb.from(TABLE_PLAYERS).update({ password_hash }).eq('name', name);
  if (error) {
    markCloudError(error);
    throw error;
  }
  markCloudOk();
}

// Simple initial Supabase connectivity check
async function initialCloudCheck() {
  try {
    // keep UI consistent
    setCloudStatus('checking', 'Checking cloud‚Ä¶');

    // cheap HEAD-style query against players table
    const { error } = await sb
      .from(TABLE_PLAYERS)
      .select('name', { head: true, count: 'exact' });

    if (error) throw error;
    markCloudOk();
  } catch (err) {
    markCloudError(err);
  }
}

// HIGH SCORES
async function cloudInsertHighScore(name, score, single=false){
  const table   = single ? TABLE_HS_PRACTICE : TABLE_HS_LEAGUE;
  const payload = { name, score, ts: new Date().toISOString() };
  const { error } = await sb.from(table).insert(payload);
  if (error) {
    markCloudError(error);
    throw error;
  }
  markCloudOk();
}

async function cloudListHighScores(single=false, limit=20){
  const table = single ? TABLE_HS_PRACTICE : TABLE_HS_LEAGUE;
  const { data, error } = await sb.from(table)
    .select('name, score, ts')
    .order('score', { ascending:false })
    .order('ts', { ascending:true })
    .limit(limit);
  if (error) {
    markCloudError(error);
    throw error;
  }
  markCloudOk();
  return data || [];
}

async function cloudDeleteHighScore(row, single=false){
  const table = single ? TABLE_HS_PRACTICE : TABLE_HS_LEAGUE;
  const { error } = await sb.from(table).delete()
    .eq('name', row.name)
    .eq('score', row.score)
    .eq('ts', row.ts);
  if (error) {
    markCloudError(error);
    throw error;
  }
  markCloudOk();
}

/*****************
 * DETAILS PAGE (page 1)
 *****************/
const resumeBtn=byId('resumeBtn');
function getSavedState(){ 
  try{
    const raw=localStorage.getItem(STORAGE_KEY); 
    if(!raw) return null; 
    const saved=JSON.parse(raw); 
    if(!saved||!Array.isArray(saved.players)||!saved.players.length) return null; 
    return saved;
  }catch(e){ 
    return null; 
  } 
}
function setupStartMenuButtons(){ 
  const saved=getSavedState(); 
  const hasSaved=!!saved; 
  resumeBtn.disabled=!hasSaved; 
  resumeBtn.title=hasSaved?'Resume last match':'No saved match'; 
  if(hasSaved){ 
    resumeBtn.onclick=()=>{ 
      Object.assign(state,saved); 
      show('game'); 
      assignUniqueColors(state.players); 
      buildEverything(); 
      updateUI(); 
      toast('Resumed last match'); 
    }; 
  } else { 
    resumeBtn.onclick=null; 
  }
  byId('hsMenuBtn').onclick   = openHighScoresDialog; 
  byId('hsMenuBtnSP').onclick = openHighScoresDialogSP; 

  // TEMP: wire Player Stats to a placeholder dialog
  byId('playerStatsBtn').onclick = () => {
    toast('Player Stats coming soon');
  };
}

byId('questBtn').addEventListener('click', ()=>{
  // go to Player Select
  show('players');
  // sync dropdown defaults from details (if you want, you can keep psNumGames default 5)
});

byId('startScreenBtn')?.addEventListener('click', ()=>show('details'));
byId('startScreenBtnLB')?.addEventListener('click', ()=>show('details'));
byId('backToDetailsBtn')?.addEventListener('click', ()=>show('details'));

byId('adminEnterBtn').addEventListener('click', ()=>{
  const code=(byId('adminCode')?.value||'').trim();
  if(code.toLowerCase()==='hownowbrowncow'){
    byId('adminCode').value='';
    openAdminHub();
  }else{
    toast('Invalid code');
  }
});

/*****************
 * PLAYER SELECT (page 2)
 *****************/
const psNumGamesSel = byId('psNumGames');
const psNumPlayersSel = byId('psNumPlayers');
const psPlayerFields = byId('psPlayerFields');

function drawPsRows(){
  const count = parseInt(psNumPlayersSel.value,10) || 2;
  psPlayerFields.innerHTML = '';
  for(let i=1;i<=count;i++){
    const row = document.createElement('div');
    row.className='row pf';
    row.dataset.index=String(i);
    row.innerHTML = `
      <div class="grow"><input placeholder="Guest Player Name" data-role="display"></div>
      <button class="btn select-player-btn" type="button">Select Player</button>
      <button class="btn primary save-player-btn" type="button">Save Player</button>
    `;
    psPlayerFields.appendChild(row);
  }
  // wire buttons per row
  [...psPlayerFields.querySelectorAll('.pf')].forEach(row=>{
    const idx = parseInt(row.dataset.index,10);
    row.querySelector('.select-player-btn').onclick = ()=> showSelectPlayerDialog(idx);
    row.querySelector('.save-player-btn').onclick = ()=> showAddPlayerDialog(idx);
  });
}

psNumPlayersSel.addEventListener('change', drawPsRows);
psNumGamesSel.addEventListener('change', ()=>{/* nothing else; read on start */});
// ---- Saved players helpers (shared by Add + Select modals) ----
function getSavedPlayers(){
  try { return JSON.parse(localStorage.getItem('shateki_players') || '[]'); }
  catch(e){ return []; }
}
function setSavedPlayers(arr){
  try { localStorage.setItem('shateki_players', JSON.stringify(arr)); }
  catch(e){}
}
function populateSavedPlayersSelects(){
  const arr = getSavedPlayers();
  const sel1 = document.getElementById('existingPlayers');       // Add Player modal
  const sel2 = document.getElementById('existingPlayerSelect');  // Select Player modal
  [sel1, sel2].forEach(sel=>{
    if(!sel) return;
    sel.innerHTML = '<option value=\"\">Select a saved player...</option>' +
      arr.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
  });
}
async function showAddPlayerDialog(index){
  const modal = byId('addPlayerModal');
  if (!modal) { toast('Add Player modal missing'); return; }

  let chosenName = '';

  function finish(msg){
    const idx = parseInt(modal.dataset.playerIndex || '0', 10) || 1;
    const row =
      document.querySelector(`#psPlayerFields .pf[data-index="${idx}"]`) ||
      document.querySelector(`.pf[data-index="${idx}"]`);
    const input = row?.querySelector('input[data-role="display"]');
    if (input) input.value = chosenName || '';

    // close + reset
    modal.classList.add('hidden');
    byId('newPlayerName').value = '';
    byId('newPlayerPassword').value = '';
    toast(msg);
  }

  // Reset fields
  byId('newPlayerName').value = '';
  byId('newPlayerPassword').value = '';

  // Remember which row invoked the dialog
  modal.dataset.playerIndex = index ? String(index) : '';

  // Show
  modal.classList.remove('hidden');

  // Wire buttons
  const saveBtn   = byId('savePlayerBtn');
  const cancelBtn = byId('cancelAddPlayerBtn');

  saveBtn.onclick = async () => {
    const newName = byId('newPlayerName').value.trim();
    const newPass = byId('newPlayerPassword').value;

    if (!newName || !newPass) {
      toast('Enter name & password');
      return;
    }

    // Local duplicate check (same device)
    const players = getSavedPlayers();
    if (players.some(p => p.name.toLowerCase() === newName.toLowerCase())) {
      toast('Name already exists');
      return;
    }

    // Cloud create (global, multi-device)
    try {
      await cloudCreatePlayer(newName, newPass);
    } catch (err) {
      console.error(err);
      toast('Cloud save failed');
      return;
    }

    // Also keep a local cache for offline / legacy behaviour
    players.push({ name: newName, password: newPass });
    setSavedPlayers(players);

    chosenName = newName;
    finish('Player saved');
  };

  cancelBtn.onclick = () => modal.classList.add('hidden');
}

async function showSelectPlayerDialog(index){
  const select = byId('existingPlayerSelect');
  select.innerHTML = '<option value="">Select a saved player...</option>';
  try{
    // Primary: cloud players
    const list = await cloudListPlayers();
    list.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = p.name;
      select.appendChild(opt);
    });

    // Fallback: legacy local players if cloud is empty
    if (!list.length) {
      const local = getSavedPlayers();
      local.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        select.appendChild(opt);
      });
    }

    const modal = byId('selectPlayerModal');
    modal.dataset.playerIndex = String(index);
    modal.classList.remove('hidden');
  }catch(err){
    console.error(err);
    toast('Load players failed');
  }
}

byId('cancelSelectPlayerBtn').addEventListener('click', ()=>{
  byId('existingPlayerSelect').value='';
  byId('playerPassword').value='';
  byId('selectPlayerModal').classList.add('hidden');
});

byId('confirmSelectPlayerBtn').onclick = async () => {
  const modal = byId('selectPlayerModal');
  const idx   = parseInt(modal.dataset.playerIndex || '0', 10) || 1;

  const name = byId('existingPlayerSelect').value;
  const pass = byId('playerPassword').value;

  if (!name || !pass) {
    toast('Enter player & password');
    return;
  }

  let ok = false;

  // Try cloud first
  try {
    ok = await cloudValidatePlayer(name, pass);
  } catch (err) {
    console.error(err);
  }

  // Fallback to local cache if cloud fails or returns false
  if (!ok) {
    const players = getSavedPlayers();
    const found   = players.find(p => p.name === name);
    if (!found || found.password !== pass) {
      toast('Incorrect name or password');
      return;
    }
  }

  // Write back into the correct Player Select row
  const row =
    document.querySelector(`#psPlayerFields .pf[data-index="${idx}"]`) ||
    document.querySelector(`.pf[data-index="${idx}"]`);
  const input = row?.querySelector('input[data-role="display"]');
  if (input) input.value = name;

  byId('playerPassword').value = '';
  byId('existingPlayerSelect').value = '';
  modal.classList.add('hidden');
  toast('Player selected');
};

byId('startMatchBtn').addEventListener('click', ()=>{
  // Build state from Player Select
  const games = parseInt(psNumGamesSel.value,10) || 1;
  const rows = [...psPlayerFields.querySelectorAll('.pf')];
  const ppl = rows.map((row,i)=>({
    name:(row.querySelector('input[data-role="display"]').value||'').trim() || `Player ${i+1}`
  }));
  if(!ppl.length){ toast('Add at least 1 player'); return; }
  state.players = ppl.map(p=>({ name:p.name, color:null }));
  assignUniqueColors(state.players);
  state.match = { totalGames:games, gameNumber:1, wins:Array.from({length:state.players.length},()=>0), history:[] };
  state.matchAgg=null; ensureMatchAgg();
  startNewGame(false); // will show order dialog first
  setupStartMenuButtons();
  save();
});

/*****************
 * BUILDERS
 *****************/
const thead=byId('thead'), tbody=byId('tbody');
const statsThead=byId('statsThead'), statsTbody=byId('statsTbody');
const mstatsThead=byId('mstatsThead'), mstatsTbody=byId('mstatsTbody');
const floatThead=byId('floatThead');

function buildScoreHeader(){ 
  // Main scoreboard header is now minimal ‚Äì only used for layout/scroll sync.
  thead.innerHTML = '';

  const tr = document.createElement('tr');

  // Left column label
  const thRound = document.createElement('th');
  thRound.textContent = 'Round';
  tr.appendChild(thRound);

  // One blank header cell per player (no Game Wins / names / totals here)
  for (let i = 0; i < state.players.length; i++) {
    const th = document.createElement('th');
    th.className = 'player';
    th.textContent = ''; // keep it visually empty; floating header shows the info
    tr.appendChild(th);
  }

  thead.appendChild(tr);
}

function buildScoreBody(){ 
  tbody.innerHTML=''; 
  for(let r=0;r<MAX_ROUNDS;r++){ 
    const tr=document.createElement('tr'); 
    const th=document.createElement('th'); 
    th.textContent=(ROUNDS[r].type==='number')?(ROUNDS[r].target+'s'):(ROUNDS[r].type==='doubles'?'Doubles':(ROUNDS[r].type==='triples'?'Triples':'Bull')); 
    tr.appendChild(th); 
    for(let p=0;p<state.players.length;p++){ 
      const td=document.createElement('td'); 
      td.className='center num player'; 
      td.id=`cell-${p}-${r}`; 
      td.textContent='‚Äì'; 
      tr.appendChild(td);
    } 
    tbody.appendChild(tr);
  } 
}

function buildFloatingHeader(){ 
  floatThead.innerHTML='';

  // Wins row
  const trWins=document.createElement('tr'); 
  const thWins=document.createElement('th'); thWins.textContent='Game Wins'; trWins.appendChild(thWins);
  for(let i=0;i<state.players.length;i++){ 
    const th=document.createElement('th'); th.className='player'; th.style.color=state.players[i].color; 
    const wins=document.createElement('div'); wins.className='th-beers'; wins.id='fbeers-'+i; wins.textContent=''; 
    th.appendChild(wins); trWins.appendChild(th);
  }  

  // Names row
  const trNames=document.createElement('tr'); 
  const thNames=document.createElement('th'); thNames.textContent='Player'; trNames.appendChild(thNames);
  for(let i=0;i<state.players.length;i++){ 
    const th=document.createElement('th'); th.className='player'; th.style.color=state.players[i].color; 
    const wrap=document.createElement('div'); wrap.className='th-wrap'; 
    const name=document.createElement('div'); name.className='th-name'; name.textContent=state.players[i].name; 
    const arrow=document.createElement('div'); arrow.className='th-throw-arrow'; arrow.id='fdartarrow-'+i; arrow.textContent=''; 
    wrap.append(name,arrow); th.appendChild(wrap); trNames.appendChild(th);
  }  

  // Totals row
  const trTotals=document.createElement('tr'); 
  const thTotals=document.createElement('th'); thTotals.textContent='Total'; thTotals.className='th-diff-label'; trTotals.appendChild(thTotals);
  for(let i=0;i<state.players.length;i++){ 
    const th=document.createElement('th'); th.className='player'; 
    const total=document.createElement('div'); total.className='th-total th-name num'; total.id='ftotal-'+i; total.textContent='0'; 
    th.appendChild(total); trTotals.appendChild(th);
  }  

  // Diff row
  const trDiff=document.createElement('tr'); 
  const thDiff=document.createElement('th'); thDiff.textContent='(+/‚àí)'; thDiff.className='th-diff-label'; trDiff.appendChild(thDiff);
  for(let i=0;i<state.players.length;i++){ 
    const th=document.createElement('th'); th.className='player'; 
    const diff=document.createElement('div'); diff.className='th-diff'; diff.id='fdiff-'+i; diff.textContent='0'; 
    th.appendChild(diff); trDiff.appendChild(th);
  }  

  floatThead.append(trWins,trNames,trTotals,trDiff);
}

/*****************
 * STATS (modal compute)
 *****************/
const METRICS = [
  { key: 'miss',         label: '% Miss',           fmt: v => v + '%' },
  { key: 'single',       label: '% Singles',        fmt: v => v + '%' },
  { key: 'double',       label: '% Doubles',        fmt: v => v + '%' },
  { key: 'treble',       label: '% Trebles',        fmt: v => v + '%' },
  { key: 'bulls',        label: '% Bulls (I+O)',    fmt: v => v + '%' },

  // NEW: per-round power scoring
  { key: 'sixtyPlus',    label: '60+ Rounds',       fmt: v => String(v) },
  { key: 'hundredPlus',  label: '100+ Rounds',      fmt: v => String(v) },
  { key: 'oneFortyPlus', label: '140+ Rounds',      fmt: v => String(v) },

  { key: 'avg9',         label: 'Avg (last 9)',     fmt: v => v.toFixed(1) },
  { key: 'avgRound',     label: 'Avg (round)',      fmt: v => v.toFixed(1) },
  { key: 'avgGame',      label: 'Avg (throw)',      fmt: v => v.toFixed(1) },
  { key: 'singleStreak', label: 'Single Streak',    fmt: v => String(v) },
  { key: 'roundStreak',  label: 'Round Streak',     fmt: v => String(v) },
  { key: 'bestNumber',   label: 'Best Number',      fmt: v => v || '‚Äî' }
];
function computeStatsFromBoards(boards, pIdx) {
  // boards: array of [player][round] objects in the same shape as state.score

  const dartsFlat = [];
  const perNumberTotals = {};
  const perRoundHit = [];

  let completedRounds = 0;
  let completedPoints = 0;
  let rounds60 = 0, rounds100 = 0, rounds140 = 0;

  boards.forEach(board => {
    if (!board || !board[pIdx]) return;

    for (let r = 0; r < MAX_ROUNDS; r++) {
      const roundDef = ROUNDS[r];
      const entry = board[pIdx][r];
      if (!entry) continue;

      const d = entry.darts || [];
      const roundIndex = perRoundHit.length;
      perRoundHit.push(false);

      const roundTotal = entry.roundTotal || 0;

      d.forEach(dart => {
        if (!dart) return;
        const p = dart.points || 0;

        dartsFlat.push({ dart, roundIndex, roundDef });

        if (p > 0) {
          perRoundHit[roundIndex] = true;
        }
      });

      // fully completed round = 3 darts thrown
      if (d[0] && d[1] && d[2]) {
        completedRounds++;
        completedPoints += roundTotal;
      }

      if (roundTotal >= 60) rounds60++;
      if (roundTotal >= 100) rounds100++;
      if (roundTotal >= 140) rounds140++;

      // Best number tracking
      d.forEach(dart => {
        if (!dart || !(dart.points > 0)) return;
        let key = null;

        if (roundDef.type === 'number') {
          key = String(roundDef.target);
        } else if (roundDef.type === 'doubles' || roundDef.type === 'triples') {
          if (dart.sector) key = String(dart.sector);
        } else if (roundDef.type === 'bull') {
          key = 'Bull';
        }

        if (key) {
          perNumberTotals[key] = (perNumberTotals[key] || 0) + (dart.points || 0);
        }
      });
    }
  });

  const n = dartsFlat.length;
  let miss = 0, singles = 0, doubles = 0, trebles = 0, bulls = 0, pts = 0;

  let currentHitStreak = 0;
  let bestHitStreak = 0;

  for (const { dart } of dartsFlat) {
    const p = dart.points || 0;
    pts += p;

    const isHit = p > 0;
    if (isHit) {
      currentHitStreak++;
      if (currentHitStreak > bestHitStreak) bestHitStreak = currentHitStreak;
    } else {
      currentHitStreak = 0;
    }

    if (dart.kind === 'Miss') miss++;
    else if (dart.kind === 'Bull') bulls++;
    else if (dart.kind === 'S' || dart.kind === 'Single') singles++;
    else if (dart.kind === 'D' || dart.kind === 'Double') doubles++;
    else if (dart.kind === 'T' || dart.kind === 'Triple') trebles++;
  }

  const pct = v => n ? Math.round((v / n) * 100) : 0;

  const last9 = dartsFlat.slice(-9);
  const sum9  = last9.reduce((a, x) => a + (x.dart.points || 0), 0);
  const avg9  = last9.length ? (sum9 / last9.length) : 0;

  const avgGame  = n ? (pts / n) : 0;
  const avgRound = completedRounds ? (completedPoints / completedRounds) : 0;

  // Round streak across all rounds in all boards
  let currentRoundStreak = 0;
  let bestRoundStreak = 0;
  for (const hit of perRoundHit) {
    if (hit) {
      currentRoundStreak++;
      if (currentRoundStreak > bestRoundStreak) bestRoundStreak = currentRoundStreak;
    } else {
      currentRoundStreak = 0;
    }
  }

  // Best number
  let bestNumberKey = null;
  let bestNumberScore = 0;
  Object.keys(perNumberTotals).forEach(key => {
    const total = perNumberTotals[key];
    if (total > bestNumberScore) {
      bestNumberScore = total;
      bestNumberKey = key;
    }
  });
  const bestNumberLabel = bestNumberKey
    ? (bestNumberKey === 'Bull'
        ? `Bull (${bestNumberScore})`
        : `${bestNumberKey} (${bestNumberScore})`)
    : '‚Äî';

  return {
    miss: pct(miss),
    single: pct(singles),
    double: pct(doubles),
    treble: pct(trebles),
    bulls: pct(bulls),

    sixtyPlus:    rounds60,
    hundredPlus:  rounds100,
    oneFortyPlus: rounds140,

    avg9,
    avgRound,
    avgGame,
    singleStreak: bestHitStreak,
    roundStreak:  bestRoundStreak,
    bestNumber:   bestNumberLabel,

    totalThrows:  n,
    totalHits:    n - miss,
    totalMisses:  miss,
    bestNumberKey,
    bestNumberScore
  };
}

// Per-game stats (current board only)
function computeStatsForPlayerGame(pIdx) {
  return computeStatsFromBoards([state.score], pIdx);
}

// Per-match stats (all finished games + current game)
function computeStatsForPlayerMatch(pIdx) {
  const boards = [];

  if (state.match && Array.isArray(state.match.history)) {
    state.match.history.forEach(g => {
      if (g && Array.isArray(g.board)) boards.push(g.board);
    });
  }

  if (state.score && state.score[pIdx]) {
    boards.push(state.score);
  }

  if (!boards.length) {
    return computeStatsFromBoards([], pIdx);
  }
  return computeStatsFromBoards(boards, pIdx);
}
function buildStatsHeader(){ 
  statsThead.innerHTML = '';
  const tr = document.createElement('tr');

  const thLabel = document.createElement('th');
  thLabel.textContent = 'Game Stats';
  tr.appendChild(thLabel);

  // one column per player (we keep header blank ‚Äì names are in the popup)
  for (let i = 0; i < state.players.length; i++) {
    const th = document.createElement('th');
    th.className = 'player';
    tr.appendChild(th);
  }

  statsThead.appendChild(tr);
}

function buildStatsBody(){ 
  statsTbody.innerHTML = '';

  METRICS.forEach(m => {
    const tr = document.createElement('tr');

    const th = document.createElement('th');
    th.className = 'stats-th';
    th.textContent = m.label;
    tr.appendChild(th);

    for (let p = 0; p < state.players.length; p++) {
      const td = document.createElement('td');
      td.className = 'center num player';
      td.id = `stat-${m.key}-${p}`;    // used by updateStatsRows()
      td.textContent = '‚Äî';
      tr.appendChild(td);
    }

    statsTbody.appendChild(tr);
  });
}

function buildMatchStatsHeader(){ 
  mstatsThead.innerHTML = '';
  const tr = document.createElement('tr');

  const thLabel = document.createElement('th');
  thLabel.textContent = 'Match Stats';
  tr.appendChild(thLabel);

  for (let i = 0; i < state.players.length; i++) {
    const th = document.createElement('th');
    th.className = 'player';
    tr.appendChild(th);
  }

  mstatsThead.appendChild(tr);
}

function buildMatchStatsBody(){ 
  mstatsTbody.innerHTML = '';

  METRICS.forEach(m => {
    const tr = document.createElement('tr');

    const th = document.createElement('th');
    th.className = 'stats-th';
    th.textContent = m.label;
    tr.appendChild(th);

    for (let p = 0; p < state.players.length; p++) {
      const td = document.createElement('td');
      td.className = 'center num player';
      td.id = `mstat-${m.key}-${p}`;   // used by updateMatchStats()
      td.textContent = '‚Äî';
      tr.appendChild(td);
    }

    mstatsTbody.appendChild(tr);
  });
}

// Fill the hidden match-stats table so widths stay in sync and data is there if needed
function updateMatchStats(){ 
  for (let i = 0; i < state.players.length; i++) {
    const v = computeStatsForPlayerMatch(i);
    for (const m of METRICS) {
      const td = byId(`mstat-${m.key}-${i}`);
      if (td) td.textContent = m.fmt(v[m.key]);
    }
  }
}
/*****************
 * UI UPDATE
 *****************/
function computeRoundMaxes(){ 
  const arr=new Array(MAX_ROUNDS); 
  for(let r=0;r<MAX_ROUNDS;r++){ 
    let m=0; for(let p=0;p<state.players.length;p++){ m=Math.max(m, state.score[p][r].roundTotal||0); } 
    arr[r]=m; 
  } return arr; 
}
function lastPlayedRoundForPlayer(pIdx){ 
  for(let r=MAX_ROUNDS-1;r>=0;r--){ 
    const d=state.score[pIdx][r].darts||[]; 
    if(d[0]||d[1]||d[2]) return r; 
  } 
  return -1; 
}
function updateWinsHeaderDots(){ 
  const total=state.match.totalGames||1; 
  for(let i=0;i<state.players.length;i++){ 
    const el=byId('fbeers-'+i); if(!el) continue; 
    const won=state.match.wins[i]||0; 
    const dots='ü•á'.repeat(Math.min(won,total)) + '‚óØ'.repeat(Math.max(0,total-won)); 
    el.textContent=dots; 
  } 
}
function updateHeaderStrip(){ 
  for(let i=0;i<state.players.length;i++){ 
    const isTurn = (!state.finished && i===state.currentPlayer && !state.suddenDeath.active); 
    const arrEl=byId('fdartarrow-'+i); if(arrEl) arrEl.textContent = isTurn ? 'üéØ'.repeat(3 - state.currentDart) : ''; 
  } 
  const totals=state.players.map((_,i)=>totalScoreForPlayer(i)); 
  const leader = Math.max(0,...totals); 
  for(let i=0;i<state.players.length;i++){ 
    byId('ftotal-'+i).textContent=String(totals[i]||0); 
    byId('fdiff-'+i).textContent=String((totals[i]-leader)||0); 
  } 
  updateWinsHeaderDots(); 
}
function updateScoreCells(){ 
  document.querySelectorAll('.current-cell').forEach(n=>n.classList.remove('current-cell')); 
  document.querySelectorAll('.current-col').forEach(n=>n.classList.remove('current-col')); 
  const roundMax=computeRoundMaxes(); 
  for(let p=0;p<state.players.length;p++){ 
    let running=0; 
    const lastPlayed=lastPlayedRoundForPlayer(p); 
    for(let r=0;r<MAX_ROUNDS;r++){ 
      const td=byId(`cell-${p}-${r}`); 
      const entry=state.score[p][r]; 
      const roundPts=entry.roundTotal||0; 
      const hasDart=entry.darts[0]||entry.darts[1]||entry.darts[2]; 
      running+=roundPts; 
      if(r<=lastPlayed){ 
        const subText=hasDart?(roundPts===0?'‚Äì':String(roundPts)):'‚Äì'; 
        const isTop=(roundPts===roundMax[r] && roundMax[r]>0); 
        td.innerHTML=`<span class="cell-wrap"><span class="cell-main">${running}</span><span class="cell-sub${isTop?' sub-win':''}">(${subText})</span></span>`; 
      } else td.textContent='‚Äì'; 
    } 
  }
  if(!state.finished && !state.suddenDeath.active){ 
    const cur=byId(`cell-${state.currentPlayer}-${state.currentRound}`); if(cur) cur.classList.add('current-cell'); 
    const headers=thead.querySelectorAll('tr:last-child th'); if(headers[state.currentPlayer+1]) headers[state.currentPlayer+1].classList.add('current-col'); 
    for(let rr=0;rr<MAX_ROUNDS;rr++){ const c=byId(`cell-${state.currentPlayer}-${rr}`); if(c) c.classList.add('current-col'); } 
  } 
}
function updateStatsRows(){ 
  for(let i=0;i<state.players.length;i++){ 
    const v=computeStatsForPlayerGame(i); 
    for(const m of METRICS){ 
      const td=byId(`stat-${m.key}-${i}`); if(td) td.textContent=m.fmt(v[m.key]); 
    } 
  } 
}
function updateUI(){ 
  updateHeaderStrip(); 
  updateScoreCells(); 
  updateStatsRows(); 
  updateMatchStats(); 
  buildPad(); 
  save(); 
}

/*****************
 * PAD + INPUT
 *****************/
const pad=byId('pad'), padHint=byId('padHint');
function buildPad(){ 
  if (!pad) return; 
  pad.innerHTML = ''; 

  const page = document.body.getAttribute('data-page');

  // Leaderboard: show tools only
  if (page === 'leaderboard') {
    padHint.textContent = '';
    addPadUtilityButtons();
    return;
  }

  // Other non-game pages: no pad
  if (page !== 'game') {
    padHint.textContent = '';
    return;
  }

  // Game page
  padHint.textContent = state.finished ? 'Game finished.' : '';

  if (!state.finished) {
    const r = ROUNDS[state.currentRound];

    if (r?.type === 'number') {
      ['S','D','T'].forEach(k => {
        const b = document.createElement('button');
        b.className = 'btn primary';
        b.textContent = k;
        b.onclick = () => recordThrow({ kind: k });
        pad.appendChild(b);
      });

      const miss = document.createElement('button');
      miss.className = 'btn danger';
      miss.textContent = 'Miss';
      miss.onclick = () => recordThrow({ kind: 'Miss' });
      pad.appendChild(miss);

      const undoBtn = document.createElement('button');
      undoBtn.className = 'btn warn';
      undoBtn.textContent = 'Undo';
      undoBtn.onclick = undo;
      pad.appendChild(undoBtn);

      const missGoBtn = document.createElement('button');
      missGoBtn.className = 'btn';
      missGoBtn.textContent = 'Miss Go';
      missGoBtn.onclick = missGo;
      pad.appendChild(missGoBtn);

    } else if (r?.type === 'doubles' || r?.type === 'triples') {
      const pref = r.type === 'doubles' ? 'D' : 'T';

      for (let n = 1; n <= 20; n++) {
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = pref + n;
        b.onclick = () =>
          recordThrow({ kind: pref === 'D' ? 'Double' : 'Triple', sector: n });
        pad.appendChild(b);
      }

      const miss = document.createElement('button');
      miss.className = 'btn danger';
      miss.textContent = 'Miss';
      miss.onclick = () => recordThrow({ kind: 'Miss' });
      pad.appendChild(miss);

      const undoBtn = document.createElement('button');
      undoBtn.className = 'btn warn';
      undoBtn.textContent = 'Undo';
      undoBtn.onclick = undo;
      pad.appendChild(undoBtn);

      const missGoBtn = document.createElement('button');
      missGoBtn.className = 'btn';
      missGoBtn.textContent = 'Miss Go';
      missGoBtn.onclick = missGo;
      pad.appendChild(missGoBtn);

    } else if (r?.type === 'bull') {
      [['Outer (25)', 'Outer'], ['Inner (50)', 'Inner']].forEach(([lbl, val]) => {
        const b = document.createElement('button');
        b.className = 'btn primary';
        b.textContent = lbl;
        b.onclick = () => recordThrow({ kind: 'Bull', bull: val });
        pad.appendChild(b);
      });

      const miss = document.createElement('button');
      miss.className = 'btn danger';
      miss.textContent = 'Miss';
      miss.onclick = () => recordThrow({ kind: 'Miss' });
      pad.appendChild(miss);

      const undoBtn = document.createElement('button');
      undoBtn.className = 'btn warn';
      undoBtn.textContent = 'Undo';
      undoBtn.onclick = undo;
      pad.appendChild(undoBtn);

      const missGoBtn = document.createElement('button');
      missGoBtn.className = 'btn';
      missGoBtn.textContent = 'Miss Go';
      missGoBtn.onclick = missGo;
      pad.appendChild(missGoBtn);
    }

  } else {
    // Finished game: go to leaderboard
    const finishBtn = document.createElement('button');
    finishBtn.className = 'btn good';
    finishBtn.style.minWidth = '220px';
    finishBtn.textContent = 'Finish Game ‚Üí Leaderboard';
    finishBtn.onclick = async () => {
      // Prevent the finish modal from re-opening via the interval
      state.finished = false;
      await awardAndShowLeaderboard();
    };
    pad.appendChild(finishBtn);
  }

  // Game page always gets the utility buttons as well
  addPadUtilityButtons();
}
function missGo(){ 
  if(state.finished) return; 
  if(state.currentDart<2) state.currentDart=2; 
  const e=state.score[state.currentPlayer][state.currentRound]; 
  e.darts[0]=e.darts[0]||{kind:'Miss',points:0}; 
  e.darts[1]=e.darts[1]||{kind:'Miss',points:0}; 
  e.darts[2]=e.darts[2]||{kind:'Miss',points:0}; 
  e.roundTotal=0; 
  state.history.push({player:state.currentPlayer, round:state.currentRound, dartIndex:2, throw:{kind:'Miss',points:0}}); 
  state.currentDart=0; 
  if(state.currentPlayer < state.players.length-1) state.currentPlayer++; 
  else{ 
    state.currentPlayer=0; 
    if(state.currentRound < MAX_ROUNDS-1) state.currentRound++; 
    else { 
      state.finished=true; 
      updateUI(); 
      openFinishModal(); 
      return; 
    } 
  } 
  updateUI(); 
}
function undo(){ 
  if (state.history.length === 0) return; 

  const last = state.history.pop(); 
  const e    = state.score[last.player][last.round]; 
  const prev = e.darts[last.dartIndex]; 

  // Adjust favourite-number hits
  if (prev && prev.kind!=='Miss'){ 
    const r = ROUNDS[last.round]; 
    let key = null; 
    if (r.type==='number') key = String(r.target); 
    else if (r.type==='doubles'||r.type==='triples') key = String(prev.sector); 
    else if (r.type==='bull') key = 'Bull'; 
    if (key){ 
      const map = state.matchAgg?.hits?.[last.player]; 
      if (map && map[key]) map[key]--; 
    } 
  } 

  // Remove dart and recompute round total
  e.darts[last.dartIndex] = null; 
  e.roundTotal =
    (e.darts[0]?.points||0) +
    (e.darts[1]?.points||0) +
    (e.darts[2]?.points||0); 

  // Recompute 60+/100+/140+ counters for this player
  recomputeMatchAggTotalsForPlayer(last.player);

  state.currentPlayer = last.player; 
  state.currentRound  = last.round; 
  state.currentDart   = last.dartIndex; 
  state.finished      = false; 

  updateUI(); 
}

/*****************
 * DIALOGS (Stats / Race / High Scores)
 *****************/
function openGameStatsDialog(){ 
  const overlay=document.createElement('div'); overlay.className='modal-backdrop'; 
  const modal=document.createElement('div'); modal.className='modal'; 
  const title=document.createElement('h3'); title.textContent='Game Stats'; 
  const body=document.createElement('div'); body.className='modal-body'; 
  const table=document.createElement('table'); table.className='hs-table'; 
  const thead=document.createElement('thead'); const trh=document.createElement('tr'); 
  trh.appendChild(Object.assign(document.createElement('th'),{textContent:'Metric'})); 
  state.players.forEach(p=> trh.appendChild(Object.assign(document.createElement('th'),{textContent:p.name}))); 
  thead.appendChild(trh); table.appendChild(thead); 
  const tb=document.createElement('tbody'); 
  const vByP=state.players.map((_,i)=>computeStatsForPlayerGame(i)); 
  METRICS.forEach(m=>{ 
    const tr=document.createElement('tr'); 
    tr.appendChild(Object.assign(document.createElement('th'),{textContent:m.label,className:'stats-th'})); 
    state.players.forEach((_,i)=>{ 
      const td=document.createElement('td'); td.className='center num'; td.textContent=m.fmt(vByP[i][m.key]); tr.appendChild(td);
    }); 
    tb.appendChild(tr);
  }); 
  table.appendChild(tb); body.appendChild(table); 
  const footer=document.createElement('div'); footer.className='modal-footer'; 
  const backBtn=document.createElement('button'); backBtn.className='btn'; backBtn.textContent='Back'; backBtn.onclick=()=>overlay.remove(); footer.appendChild(backBtn); 
  modal.append(title,body,footer); overlay.appendChild(modal); document.body.appendChild(overlay); 
  modal.tabIndex=0; modal.focus(); 
  overlay.addEventListener('click',e=>{ if(e.target===overlay) overlay.remove();});
  overlay.addEventListener('keydown',e=>{ if(e.key==='Escape') overlay.remove();});
}

function openMatchStatsDialog(){ 
  const overlay=document.createElement('div'); overlay.className='modal-backdrop'; 
  const modal=document.createElement('div'); modal.className='modal'; 
  const title=document.createElement('h3'); title.textContent='Match Stats'; 
  const body=document.createElement('div'); body.className='modal-body'; 

  const table=document.createElement('table'); table.className='hs-table'; 
  const thead=document.createElement('thead'); const trh=document.createElement('tr'); 
  trh.appendChild(Object.assign(document.createElement('th'),{textContent:'Metric'})); 
  state.players.forEach(p=> trh.appendChild(Object.assign(document.createElement('th'),{textContent:p.name}))); 
  thead.appendChild(trh); table.appendChild(thead); 

  const tb=document.createElement('tbody'); 
  const vByP = state.players.map((_,i)=>computeStatsForPlayerMatch(i)); 

  METRICS.forEach(m => { 
    const tr=document.createElement('tr'); 
    tr.appendChild(Object.assign(document.createElement('th'),{
      textContent:m.label,
      className:'stats-th'
    })); 

    state.players.forEach((_,i) => { 
      const td=document.createElement('td'); 
      td.className='center num'; 
      td.textContent = m.fmt(vByP[i][m.key]); 
      tr.appendChild(td);
    }); 

    tb.appendChild(tr);
  }); 

  table.appendChild(tb); 
  body.appendChild(table); 

  const footer=document.createElement('div'); footer.className='modal-footer'; 
  const backBtn=document.createElement('button'); backBtn.className='btn'; backBtn.textContent='Back'; 
  backBtn.onclick = () => overlay.remove(); 
  footer.appendChild(backBtn); 

  modal.append(title,body,footer); 
  overlay.appendChild(modal); 
  document.body.appendChild(overlay); 

  modal.tabIndex=0; 
  modal.focus(); 

  overlay.addEventListener('click',e=>{ if(e.target===overlay) overlay.remove(); });
  overlay.addEventListener('keydown',e=>{ if(e.key==='Escape') overlay.remove(); });
}

async function openHighScoresDialog(){ 
  const overlay=document.createElement('div'); overlay.className='modal-backdrop'; 
  const modal=document.createElement('div'); modal.className='modal'; 
  const title=document.createElement('h3'); title.textContent='High Scores (Official)'; 
  const body=document.createElement('div'); body.className='modal-body'; 
  try{
    const list = await cloudListHighScores(false, 50);
    if(!list.length){ const p=document.createElement('p'); p.textContent='No high scores yet.'; body.appendChild(p); }
    else{
      const table=document.createElement('table'); table.className='hs-table';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      ['#','Player','Score','When'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);}); thead.appendChild(trh); table.appendChild(thead);
      const tb=document.createElement('tbody');
      list.forEach((row,idx)=>{ const tr=document.createElement('tr'); 
        const td1=document.createElement('td'); td1.textContent=String(idx+1);
        const td2=document.createElement('td'); td2.textContent=row.name;
        const td3=document.createElement('td'); td3.textContent=String(row.score);
        const td4=document.createElement('td'); td4.textContent=new Date(row.ts).toLocaleString();
        tr.append(td1,td2,td3,td4); tb.appendChild(tr);
      });
      table.appendChild(tb); body.appendChild(table);
    }
  }catch(err){ console.error(err); const p=document.createElement('p'); p.textContent='Failed to load high scores.'; body.appendChild(p); }
  const footer=document.createElement('div'); footer.className='modal-footer'; 
  const closeBtn=document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.onclick=()=>overlay.remove(); footer.appendChild(closeBtn); 
  modal.append(title,body,footer); overlay.appendChild(modal); document.body.appendChild(overlay); modal.tabIndex=0; modal.focus(); 
  overlay.addEventListener('click',e=>{ if(e.target===overlay) overlay.remove();}); overlay.addEventListener('keydown',e=>{ if(e.key==='Escape') overlay.remove();});
}

async function openHighScoresDialogSP(){ 
  const overlay=document.createElement('div'); overlay.className='modal-backdrop'; 
  const modal=document.createElement('div'); modal.className='modal'; 
  const title=document.createElement('h3'); title.textContent='High Scores (Single Player)'; 
  const body=document.createElement('div'); body.className='modal-body'; 
  try{
    const list = await cloudListHighScores(true, 50);
    if(!list.length){ const p=document.createElement('p'); p.textContent='No high scores yet.'; body.appendChild(p); }
    else{
      const table=document.createElement('table'); table.className='hs-table';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      ['#','Player','Score','When'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);}); thead.appendChild(trh); table.appendChild(thead);
      const tb=document.createElement('tbody');
      list.forEach((row,idx)=>{ const tr=document.createElement('tr'); 
        const td1=document.createElement('td'); td1.textContent=String(idx+1);
        const td2=document.createElement('td'); td2.textContent=row.name;
        const td3=document.createElement('td'); td3.textContent=String(row.score);
        const td4=document.createElement('td'); td4.textContent=new Date(row.ts).toLocaleString();
        tr.append(td1,td2,td3,td4); tb.appendChild(tr);
      });
      table.appendChild(tb); body.appendChild(table);
    }
  }catch(err){ console.error(err); const p=document.createElement('p'); p.textContent='Failed to load high scores.'; body.appendChild(p); }
  const footer=document.createElement('div'); footer.className='modal-footer'; 
  const closeBtn=document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.onclick=()=>overlay.remove(); footer.appendChild(closeBtn); 
  modal.append(title,body,footer); overlay.appendChild(modal); document.body.appendChild(overlay); modal.tabIndex=0; modal.focus(); 
  overlay.addEventListener('click',e=>{ if(e.target===overlay) overlay.remove();}); overlay.addEventListener('keydown',e=>{ if(e.key==='Escape') overlay.remove();});
}

function openGameScoresDialog(){ 
  const overlay=document.createElement('div'); overlay.className='modal-backdrop'; 
  const modal=document.createElement('div'); modal.className='modal'; 
  const title=document.createElement('h3'); title.textContent='Game Scores'; 
  const body=document.createElement('div'); body.className='modal-body'; 
  const table=document.createElement('table'); table.className='hs-table'; 
  const thead=document.createElement('thead'); const trh=document.createElement('tr'); 
  trh.appendChild(Object.assign(document.createElement('th'),{textContent:'Round'})); 
  state.players.forEach(p=> trh.appendChild(Object.assign(document.createElement('th'),{textContent:p.name}))); 
  thead.appendChild(trh); table.appendChild(thead); 
  const tb=document.createElement('tbody'); 
  for(let r=0;r<MAX_ROUNDS;r++){ 
    const tr=document.createElement('tr'); 
    const rLabel=(ROUNDS[r].type==='number')?`${ROUNDS[r].target}s`:(ROUNDS[r].type==='doubles'?'Doubles':ROUNDS[r].type==='triples'?'Triples':'Bull'); 
    tr.appendChild(Object.assign(document.createElement('th'),{textContent:rLabel,className:'stats-th'})); 
    for(let p=0;p<state.players.length;p++){ 
      const pts=state.score[p][r].roundTotal||0; 
      const td=document.createElement('td'); td.className='center num'; td.textContent=String(pts); tr.appendChild(td);
    } 
    tb.appendChild(tr);
  } 
  const trTot=document.createElement('tr'); 
  trTot.appendChild(Object.assign(document.createElement('th'),{textContent:'Total',className:'stats-th'})); 
  for(let p=0;p<state.players.length;p++){ 
    const td=document.createElement('td'); td.className='center num'; td.textContent=String(totalScoreForPlayer(p)); trTot.appendChild(td);
  } 
  tb.appendChild(trTot); table.appendChild(tb); body.appendChild(table); 
  const footer=document.createElement('div'); footer.className='modal-footer'; 
  const closeBtn=document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close'; closeBtn.onclick=()=>overlay.remove(); footer.appendChild(closeBtn); 
  modal.append(title,body,footer); overlay.appendChild(modal); document.body.appendChild(overlay); 
  modal.tabIndex=0; modal.focus(); 
  overlay.addEventListener('click',e=>{ if(e.target===overlay) overlay.remove();});
  overlay.addEventListener('keydown',e=>{ if(e.key==='Escape') overlay.remove();});
}

function openGameRaceDialog(){ 
  const overlay=document.createElement('div'); overlay.className='modal-backdrop'; 
  const modal=document.createElement('div'); modal.className='modal'; 
  const title=document.createElement('h3'); title.textContent='Race'; 
  const body=document.createElement('div'); body.className='modal-body'; 
  const legend=document.createElement('div'); legend.style.display='flex'; legend.style.flexWrap='wrap'; legend.style.gap='10px'; legend.style.marginBottom='8px'; 
  state.players.forEach(p=>{ const chip=document.createElement('span'); chip.textContent=p.name; chip.style.color=p.color; chip.style.fontWeight='800'; legend.appendChild(chip); }); 
  body.appendChild(legend); 
  const canvas=document.createElement('canvas'); canvas.width=600; canvas.height=300; body.appendChild(canvas); 
  const footer=document.createElement('div'); footer.className='modal-footer'; 
  const backBtn=document.createElement('button'); backBtn.className='btn'; backBtn.textContent='Back'; backBtn.onclick=()=>overlay.remove(); footer.appendChild(backBtn); 
  modal.append(title,body,footer); overlay.appendChild(modal); document.body.appendChild(overlay); 
  modal.tabIndex=0; modal.focus(); 
  overlay.addEventListener('click',e=>{ if(e.target===overlay) overlay.remove();});
  overlay.addEventListener('keydown',e=>{ if(e.key==='Escape') overlay.remove();}); 
  const data=generateChartData(); 
  drawLineChart(canvas,data,{labelEnds:true}); 
}

function getAllTimeHighScore() { 
  // Prefer league table max of both tables combined as "all-time"
  return null; // omit to keep chart clean (or implement a combined fetch if desired)
}

function generateChartData(){ 
  const labels=[]; for(let r=0;r<MAX_ROUNDS;r++){ labels.push(ROUNDS[r].type==='number'?`${ROUNDS[r].target}s`:(ROUNDS[r].type==='doubles'?'Doubles':ROUNDS[r].type==='triples'?'Triples':'Bull')); } 
  const datasets=[]; 
  for(let p=0;p<state.players.length;p++){ 
    const playerData=[]; let run=0; 
    for(let r=0;r<MAX_ROUNDS;r++){ run+=state.score[p][r].roundTotal||0; playerData.push(run); } 
    datasets.push({label:state.players[p].name, data:playerData, color:state.players[p].color}); 
  } 
  return {labels,datasets}; 
}
function drawLineChart(canvas,data,opts={}){ 
  const ctx=canvas.getContext('2d'); const W=canvas.width,H=canvas.height; 
  ctx.clearRect(0,0,W,H); 
  const pad=40,cw=W-2*pad,ch=H-2*pad; 
  let max=0; data.datasets.forEach(ds=>{ max=Math.max(max,...ds.data); }); max=Math.max(10,max||10); 
  ctx.strokeStyle='#2a2e48'; ctx.lineWidth=1; 
  for(let i=0;i<=5;i++){ const y=pad+(ch*i/5); ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+cw,y); ctx.stroke(); ctx.fillStyle='#a8acc3'; ctx.font='12px system-ui'; ctx.textAlign='right'; ctx.textBaseline='middle'; ctx.fillText(String(Math.round(max*(5-i)/5)), pad-8,y); } 
  for(let i=0;i<data.labels.length;i++){ const x=pad+(cw*i/(data.labels.length-1)); ctx.beginPath(); ctx.moveTo(x,pad); ctx.lineTo(x,pad+ch); ctx.stroke(); ctx.fillStyle='#a8acc3'; ctx.font='10px system-ui'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText(data.labels[i], x, pad+ch+4); } 
  data.datasets.forEach(ds=>{ 
    ctx.beginPath(); ctx.lineWidth=3; ctx.strokeStyle=ds.color; 
    for(let i=0;i<ds.data.length;i++){ const x=pad+(cw*i/(data.labels.length-1)); const y=pad+ch-(ch*ds.data[i]/max); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.stroke(); 
    ctx.fillStyle=ds.color; 
    for(let i=0;i<ds.data.length;i++){ const x=pad+(cw*i/(data.labels.length-1)); const y=pad+ch-(ch*ds.data[i]/max); ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); } 
    if(opts.labelEnds){ const i=ds.data.length-1; const x=pad+(cw*i/(data.labels.length-1)); const y=pad+ch-(ch*ds.data[i]/max); ctx.font='12px system-ui'; ctx.textAlign='left'; ctx.textBaseline='middle'; ctx.fillStyle=ds.color; ctx.fillText('  '+ds.label, Math.min(x+6, W-80), y); } 
  }); 
}

/* >>> INSERT THESE TWO NEW FUNCTIONS <<< */
function recordThrow(spec){
  // Ignore input if game is finished or in sudden death
  if (state.finished || state.suddenDeath.active) return;

  const rIndex    = state.currentRound;
  const pIndex    = state.currentPlayer;
  const dartIndex = state.currentDart;

  if (rIndex < 0 || rIndex >= MAX_ROUNDS) return;
  if (pIndex < 0 || pIndex >= state.players.length) return;
  if (dartIndex < 0 || dartIndex > 2) return;

  const roundDef = ROUNDS[rIndex];
  const entry    = state.score[pIndex][rIndex];

  let points = 0;
  let hitKey = null;
  let dartObj;

  if (spec.kind === 'Miss') {
    dartObj = { kind: 'Miss', points: 0 };
  } else if (roundDef.type === 'number') {
    const base = roundDef.target;
    if (spec.kind === 'S')      points = base;
    else if (spec.kind === 'D') points = base * 2;
    else if (spec.kind === 'T') points = base * 3;

    dartObj = { kind: spec.kind, points };
    hitKey  = String(base);
  } else if (roundDef.type === 'doubles' || roundDef.type === 'triples') {
    const sector = spec.sector || 0;
    if (!sector) {
      dartObj = { kind: 'Miss', points: 0 };
    } else {
      const mult = roundDef.type === 'doubles' ? 2 : 3;
      points = sector * mult;
      dartObj = {
        kind: roundDef.type === 'doubles' ? 'Double' : 'Triple',
        sector,
        points
      };
      hitKey = String(sector);
    }
  } else if (roundDef.type === 'bull') {
    const bull = spec.bull || 'Outer';
    points = bull === 'Inner' ? 50 : 25;
    dartObj = { kind: 'Bull', bull, points };
    hitKey  = 'Bull';
  } else {
    dartObj = { kind: 'Miss', points: 0 };
  }

  // Write dart
  entry.darts[dartIndex] = dartObj;
  entry.roundTotal =
    (entry.darts[0]?.points || 0) +
    (entry.darts[1]?.points || 0) +
    (entry.darts[2]?.points || 0);

  // History (for Undo)
  state.history.push({
    player:    pIndex,
    round:     rIndex,
    dartIndex: dartIndex,
    throw:     dartObj
  });

  // Match aggregates
  ensureMatchAgg();

  if (hitKey && points > 0) {
    const hitsMap =
      state.matchAgg.hits[pIndex] ||
      (state.matchAgg.hits[pIndex] = {});
    hitsMap[hitKey] = (hitsMap[hitKey] || 0) + 1;
  }

  // Recompute 60+/100+/140+ for this player
  recomputeMatchAggTotalsForPlayer(pIndex);

  // Advance dart / player / round
  if (state.currentDart < 2) {
    state.currentDart++;
  } else {
    state.currentDart = 0;
    if (state.currentPlayer < state.players.length - 1) {
      state.currentPlayer++;
    } else {
      state.currentPlayer = 0;
      if (state.currentRound < MAX_ROUNDS - 1) {
        state.currentRound++;
      } else {
        // Game done. Interval will open the finish modal.
        state.finished = true;
      }
    }
  }

  updateUI();
}

function recomputeMatchAggTotalsForPlayer(pIdx){
  ensureMatchAgg();
  let c60 = 0, c100 = 0, c140 = 0;

  for (let r = 0; r < MAX_ROUNDS; r++) {
    const rt =
      state.score?.[pIdx]?.[r]?.roundTotal ||
      0;
    if (rt >= 60)  c60++;
    if (rt >= 100) c100++;
    if (rt >= 140) c140++;
  }

  state.matchAgg.totals60[pIdx]  = c60;
  state.matchAgg.totals100[pIdx] = c100;
  state.matchAgg.totals140[pIdx] = c140;
}

 setInterval(()=>{ 
  try{ 
    if(document.body.getAttribute('data-page')==='game' && state && state.finished && !__finishModalOpen) openFinishModal(); 
  }catch(e){}
}, 600);

async function recordGameToHighScores(){ 
  const ts=Date.now(); 
  try{
    if (state.players.length > 1) { 
      for(let i=0;i<state.players.length;i++){ 
        const name = state.players[i].name;
        const score = totalScoreForPlayer(i);
        await cloudInsertHighScore(name, score, false);
      } 
    } else if (state.players.length === 1) { 
      const name = state.players[0].name;
      const score = totalScoreForPlayer(0);
      await cloudInsertHighScore(name, score, true);
    }
  }catch(err){
    console.error(err);
    // Fallback store locally so you don't lose the score
    const key = (state.players.length===1) ? HS_KEY_SP : HS_KEY;
    const arr = safeLoad(key) || [];
    if(state.players.length>1){
      for(let i=0;i<state.players.length;i++){ arr.push({ name: state.players[i].name, score: totalScoreForPlayer(i), ts }); }
    } else { arr.push({ name: state.players[0].name, score: totalScoreForPlayer(0), ts }); }
    safeSave(key, arr);
    toast('Cloud save failed ‚Äî stored locally');
  }
}

// Stub so finishing a game doesn't explode if full game logging isn't wired yet.
async function recordFullGameToSupabase(){
  // If/when you want to log full per-dart games to Supabase,
  // implement it here. For now it's intentionally a no-op.
  return;
}
async function awardAndShowLeaderboard(){ 
  const totals = state.players.map((_,i)=> totalScoreForPlayer(i)); 
  const max = Math.max(...totals); 
  const winners = totals.map((t,i)=> t===max?i:null).filter(x=>x!==null); 

  // Ensure wins array is sane
  if(!state.match.wins || state.match.wins.length!==state.players.length){ 
    state.match.wins = Array.from({length:state.players.length},()=>0); 
  } 

  // Bump wins + store per-game totals
  winners.forEach(i=>state.match.wins[i]++); 
  // Deep-clone current scoreboard so we can do match-wide stats later
const boardClone = JSON.parse(JSON.stringify(state.score));

state.match.history.push({
  totals: totals.slice(),
  board:  boardClone
});

  // Full game ‚Üí Supabase
  try {
    await recordFullGameToSupabase();
  } catch (e) {
    console.error(e);
    toast('Game saved to local only (cloud failed)');
  }

  // High scores ‚Üí Supabase (+ your local fallback)
  try {
    await recordGameToHighScores();
  } catch (e) {
    console.error(e);
  }

  if(state.match.gameNumber < state.match.totalGames) {
    state.match.gameNumber += 1; 
  }

  save(); 
  showLeaderboard(); 
}

const lbTable=byId('lbTable'); const lbTHead=lbTable.querySelector('thead'); const lbTBody=lbTable.querySelector('tbody');
const lbMatchInfo=byId('lbMatchInfo'); const nextGameBtn=byId('nextGameBtn'); const gameScoresBtn=byId('gameScoresBtn'); const newMatchBtn=byId('newMatchBtn'); const gamesRemainTag=byId('gamesRemainTag');
function updateLeaderboardTable(){ 
  lbTHead.innerHTML=''; lbTBody.innerHTML=''; 
  const trh=document.createElement('tr'); trh.appendChild(Object.assign(document.createElement('th'),{textContent:'Player'})); 
  for(let g=0; g<state.match.totalGames; g++){ const th=document.createElement('th'); th.textContent='G'+(g+1); trh.appendChild(th); } 
  trh.appendChild(Object.assign(document.createElement('th'),{textContent:'Match Total'})); 
  trh.appendChild(Object.assign(document.createElement('th'),{textContent:'Game Wins'})); 
  lbTHead.appendChild(trh); 
  state.players.forEach((player, idx)=>{ 
    const tr=document.createElement('tr'); 
    const nameTd=document.createElement('td'); nameTd.textContent=player.name; nameTd.style.color=player.color; tr.appendChild(nameTd); 
    let matchTotal=0; 
    for(let g=0; g<state.match.totalGames; g++){ 
      const td=document.createElement('td'); td.className='center'; 
      const t=(state.match.history[g]?.totals?.[idx])||0; td.textContent=String(t); matchTotal+=t; tr.appendChild(td); 
    } 
    const totalTd=document.createElement('td'); totalTd.className='center'; totalTd.textContent=String(matchTotal); tr.appendChild(totalTd); 
    const winsTd=document.createElement('td'); winsTd.className='center'; winsTd.textContent=String(state.match.wins[idx]||0); tr.appendChild(winsTd); 
    lbTBody.appendChild(tr); 
  }); 
}
function showLeaderboard(){ 
  show('leaderboard'); 
  updateLeaderboardTable(); 
  const completedGames=Math.min(state.match.history.length, state.match.totalGames); 
  const remaining=Math.max(0, state.match.totalGames - completedGames); 
  lbMatchInfo.textContent=`Completed: ${completedGames} / ${state.match.totalGames} ‚Ä¢ Remaining: ${remaining}`; 
  gamesRemainTag.textContent=remaining+' remaining'; 
  nextGameBtn.disabled=(remaining===0); 
}
nextGameBtn.addEventListener('click',()=>{ 
  const completedGames = state.match.history.length; 
  const remaining = Math.max(0, state.match.totalGames - completedGames); 
  if(remaining<=0){ alert('Match complete! Start a new match from the details screen.'); return; } 
  state.finished=false; 
  state.suddenDeath={active:false,participants:[],turnIndex:0,throws:[],round:1}; 
  const rot=completedGames % state.players.length; 
  startNewGame(false); 
  state.currentPlayer=rot; 
  show('game'); 
  updateUI(); 
});
newMatchBtn.addEventListener('click',()=>{ 
  if(!confirm('End current match and return to details?')) return; 
  safeClear(STORAGE_KEY); 
  Object.assign(state,{players:[],score:[],currentRound:0,currentPlayer:0,currentDart:0,history:[],finished:false,suddenDeath:{active:false,participants:[],turnIndex:0,throws:[],round:1}, match:{ totalGames:5, gameNumber:1, wins:[], history:[] }, matchAgg:null}); 
  show('details'); 
  updatePadSpacer(); 
  setupStartMenuButtons(); 
});
gameScoresBtn.addEventListener('click', openGameScoresDialog);

/*****************
 * SCROLL SYNC (keeps columns aligned)
 *****************/
let _scrollSyncSet=false; 
function setupScrollSync(){ 
  if(_scrollSyncSet) return; 
  const sw=byId('scoreWrap'), st=byId('statsWrap'), fh=byId('floatWrap'), ms=byId('mstatsWrap'); 
  if(!sw||!st||!fh||!ms) return; 
  let syncing=false; 
  function mirror(from){ 
    if(syncing) return; syncing=true; 
    const x=from.scrollLeft; [sw,st,fh,ms].forEach(el=>{ if(el!==from) el.scrollLeft=x; }); syncing=false; 
  } 
  [sw,st,fh,ms].forEach(el=> el.addEventListener('scroll',()=>mirror(el),{passive:true})); 
  _scrollSyncSet=true; 
  requestAnimationFrame(()=>{ 
    const sRow=thead?.querySelector('tr'), tRow=statsThead?.querySelector('tr'), fRow=floatThead?.querySelector('tr'); 
    if(!sRow||!tRow||!fRow) return; 
    const sCells=sRow.children, tCells=tRow.children, fCells=fRow.children; 
    const leftW=sCells[0].getBoundingClientRect().width; 
    document.documentElement.style.setProperty('--left-col-w', leftW+'px'); 
    const n=Math.min(sCells.length,tCells.length,fCells.length); 
    for(let i=1;i<n;i++){ 
      const w=sCells[i].getBoundingClientRect().width; 
      [tCells[i], fCells[i]].forEach(cell=>{ if(cell){ cell.style.width=w+'px'; cell.style.minWidth=w+'px'; cell.style.maxWidth=w+'px'; } }); 
    } 
  }); 
}

/*****************
 * START/RESET + ORDER DIALOG
 *****************/
function buildEverything(){ 
  buildScoreHeader(); 
  buildScoreBody(); 
  buildFloatingHeader(); 
  buildStatsHeader(); 
  buildStatsBody(); 
  buildMatchStatsHeader(); 
  buildMatchStatsBody(); 
  setupScrollSync(); 
}

// Throw order selection
function showPlayerOrderDialog() {
  const overlay = document.createElement('div');
  overlay.className = 'modal-backdrop';
  const modal = document.createElement('div');
  modal.className = 'modal';
  const title = document.createElement('h3'); title.textContent = 'Select Throwing Order';
  const body = document.createElement('div'); body.className = 'modal-body';
  const instructions = document.createElement('p'); instructions.textContent = 'Use up/down buttons to set the throwing order:'; instructions.style.marginBottom='15px'; body.appendChild(instructions);
  const playerList = document.createElement('div'); playerList.id='playerOrderList'; playerList.style.display='flex'; playerList.style.flexDirection='column'; playerList.style.gap='8px'; body.appendChild(playerList);

  function renderList(){
    playerList.innerHTML='';
    state.players.forEach((player, index) => {
      const item = document.createElement('div');
      item.className = 'player-order-item';
      item.dataset.index = index;
      item.innerHTML = `
        <span style="background:${player.color}; color:white; padding:4px 8px; border-radius:4px; margin-right:8px;">${player.name.charAt(0)}</span>
        ${player.name}
        <div style="margin-left: auto; display:flex; gap:4px;">
          <button class="btn small" data-action="up" data-index="${index}">‚Üë</button>
          <button class="btn small" data-action="down" data-index="${index}">‚Üì</button>
        </div>
      `;
      playerList.appendChild(item);
    });
    playerList.querySelectorAll('button[data-action]').forEach(b=>{
      b.onclick = (e) => {
        const idx = parseInt(e.currentTarget.dataset.index, 10);
        const act = e.currentTarget.dataset.action;

        if (act === 'up' && idx > 0) {
          swapPlayers(idx, idx - 1);
          renderList();
        }

        if (act === 'down' && idx < state.players.length - 1) {
          swapPlayers(idx, idx + 1);
          renderList();
        }
      };
    });
  }
  renderList();

  const footer = document.createElement('div'); footer.className='modal-footer';
  const cancelBtn = document.createElement('button'); cancelBtn.className='btn'; cancelBtn.textContent = 'Cancel'; cancelBtn.onclick = () => overlay.remove();
  const confirmBtn = document.createElement('button'); confirmBtn.className='btn primary'; confirmBtn.textContent = 'Confirm Order';
  confirmBtn.onclick = () => { overlay.remove(); startNewGame(true); };
  footer.append(cancelBtn,confirmBtn);

  modal.append(title, body, footer); overlay.appendChild(modal); document.body.appendChild(overlay);
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
  overlay.addEventListener('keydown', e => { if (e.key === 'Escape') overlay.remove(); });
  modal.tabIndex = 0; modal.focus();
}

function startNewGame(setOrder=false){
  if(!setOrder){ showPlayerOrderDialog(); return; }
  state.score = Array.from({length:state.players.length},()=>Array.from({length:MAX_ROUNDS},()=>({darts:[null,null,null],roundTotal:0})));
  state.currentRound = 0; state.currentPlayer = 0; state.currentDart = 0; state.history = []; state.finished = false;
  state.suddenDeath = {active:false,participants:[],turnIndex:0,throws:[],round:1};
  ensureMatchAgg();
  show('game'); buildEverything(); updateUI(); save();
}

function restartGame() {
  if (!confirm('Are you sure you want to restart this game? All progress will be lost.')) return;
  state.finished = false;
  state.suddenDeath = {active:false, participants:[], turnIndex:0, throws:[], round:1};
  startNewGame();
  show('game'); updateUI();
}

function swapPlayers(i, j) {
  // Swap players themselves
  [state.players[i], state.players[j]] = [state.players[j], state.players[i]];

  // Swap match wins
  if (state.match && Array.isArray(state.match.wins)) {
    [state.match.wins[i], state.match.wins[j]] =
      [state.match.wins[j], state.match.wins[i]];
  }

  // Swap per-game totals already stored
  if (state.match && Array.isArray(state.match.history)) {
    state.match.history.forEach(g => {
      if (g && Array.isArray(g.totals)) {
        [g.totals[i], g.totals[j]] = [g.totals[j], g.totals[i]];
      }
    });
  }

  // Swap matchAgg stats so favourites / 60+ / 100+ / 140+ stay with the player
  if (state.matchAgg) {
    if (Array.isArray(state.matchAgg.hits)) {
      [state.matchAgg.hits[i], state.matchAgg.hits[j]] =
        [state.matchAgg.hits[j], state.matchAgg.hits[i]];
    }
    ['totals60', 'totals100', 'totals140'].forEach(key => {
      if (Array.isArray(state.matchAgg[key])) {
        [state.matchAgg[key][i], state.matchAgg[key][j]] =
          [state.matchAgg[key][j], state.matchAgg[key][i]];
      }
    });
  }
}
/*****************
 * ADMIN HUB + ADMIN PANELS
 *****************/
function openAdminHub(){
  const hub = byId('adminHubModal');
  hub.classList.remove('hidden');
  byId('openHsLeagueAdmin').onclick = ()=>{ hub.classList.add('hidden'); openHighScoresAdminDialog(false); };
  byId('openHsPracticeAdmin').onclick = ()=>{ hub.classList.add('hidden'); openHighScoresAdminDialog(true); };
  byId('openSavedPlayersAdmin').onclick = ()=>{ hub.classList.add('hidden'); openSavedPlayersAdmin(); };
  byId('closeAdminHubBtn').onclick = ()=> hub.classList.add('hidden');
}

async function openHighScoresAdminDialog(single=false){ 
  const overlay=document.createElement('div'); overlay.className='modal-backdrop'; 
  const modal=document.createElement('div'); modal.className='modal'; 
  const title=document.createElement('h3'); title.textContent=`High Scores ‚Äî Admin (${single?'Practice':'League'})`; 
  const body=document.createElement('div'); body.className='modal-body'; 
  const footer=document.createElement('div'); footer.className='modal-footer';

  async function render(){
    body.innerHTML='';
    try{
      const list = await cloudListHighScores(single, 50);
      if(!list.length){ const p=document.createElement('p'); p.textContent='No high scores.'; body.appendChild(p); return; }
      const table=document.createElement('table'); table.className='hs-table compact';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      ['#','Player','Score','When'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);}); thead.appendChild(trh); table.appendChild(thead);
      const tb=document.createElement('tbody');
      list.forEach((row,idx)=>{ 
        const tr=document.createElement('tr'); tr.style.cursor='pointer'; tr.title='Click to delete'; 
        const td1=document.createElement('td'); td1.textContent=String(idx+1);
        const td2=document.createElement('td'); td2.textContent=row.name;
        const td3=document.createElement('td'); td3.textContent=String(row.score);
        const td4=document.createElement('td'); td4.textContent=new Date(row.ts).toLocaleString();
        tr.append(td1,td2,td3,td4);
        tr.onclick=async()=>{ if(confirm(`Delete ${row.name} ‚Äî ${row.score}?`)){ try{ await cloudDeleteHighScore(row, single); await render(); }catch(e){ console.error(e); toast('Delete failed'); } } };
        tb.appendChild(tr);
      });
      table.appendChild(tb); body.appendChild(table);
    }catch(err){ console.error(err); const p=document.createElement('p'); p.textContent='Failed to load.'; body.appendChild(p); }
  }
  await render();
  const closeBtn=document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Exit'; closeBtn.onclick=()=>overlay.remove(); footer.appendChild(closeBtn); 
  modal.append(title,body,footer); overlay.appendChild(modal); document.body.appendChild(overlay); 
  overlay.addEventListener('click', e=>{ if(e.target===overlay) overlay.remove(); });
  overlay.addEventListener('keydown', e=>{ if(e.key==='Escape') overlay.remove(); }); 
  modal.tabIndex=0; modal.focus(); 
}

async function openSavedPlayersAdmin(){
  const modalWrap = byId('savedPlayersAdminModal');
  const body = byId('savedPlayersAdminBody');
  modalWrap.classList.remove('hidden');
  byId('closeSavedPlayersAdminBtn').onclick = ()=> modalWrap.classList.add('hidden');

  async function render(){
    body.innerHTML='';
    try{
      const list = await cloudListPlayers();
      if(!list.length){ body.innerHTML = '<p>No players saved.</p>'; return; }
      const table = document.createElement('table'); table.className='hs-table compact';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      ['Player','Actions'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); }); thead.appendChild(trh); table.appendChild(thead);
      const tb=document.createElement('tbody');
      list.forEach(row=>{
        const tr=document.createElement('tr');
        const tdName=document.createElement('td'); tdName.textContent=row.name; tr.appendChild(tdName);
        const tdAct=document.createElement('td'); tdAct.className='center';
        const editBtn=document.createElement('button'); editBtn.className='btn small'; editBtn.textContent='Set Password';
        editBtn.onclick=async()=>{
          const np = prompt(`New password for ${row.name}:`);
          if(!np) return;
          try{ await cloudUpdatePlayerPassword(row.name, np); toast('Updated'); }catch(e){ console.error(e); toast('Update failed'); }
        };
        const delBtn=document.createElement('button'); delBtn.className='btn small danger'; delBtn.textContent='Delete';
        delBtn.onclick=async()=>{ if(confirm(`Delete player ${row.name}?`)){ try{ await cloudDeletePlayer(row.name); await render(); }catch(e){ console.error(e); toast('Delete failed'); } } };
        tdAct.append(editBtn,' ',delBtn); tr.appendChild(tdAct); tb.appendChild(tr);
      });
      table.appendChild(tb); body.appendChild(table);
    }catch(err){ console.error(err); body.innerHTML='<p>Failed to load players.</p>'; }
  }
  await render();
}

/*****************
 * BOOT
 *****************/
document.addEventListener('DOMContentLoaded', ()=>{
  show('details'); 
  updatePadSpacer(); 
  setupStartMenuButtons(); 

  // Default draw PS rows
  drawPsRows();

  // Kick off initial cloud connectivity check
  initialCloudCheck();

  // Restart buttons
  byId('restartGameBtn').onclick = restartGame;
  byId('restartGameBtnLB').onclick = restartGame;

  // Global ESC/click-outside for add/select modals
  document.addEventListener('click', function(event) {
    const addPlayerModal = document.getElementById('addPlayerModal');
    const selectPlayerModal = document.getElementById('selectPlayerModal');
    if (addPlayerModal && !addPlayerModal.classList.contains('hidden') &&
    event.target === addPlayerModal) {
  addPlayerModal.classList.add('hidden');
}
if (selectPlayerModal && !selectPlayerModal.classList.contains('hidden') &&
    event.target === selectPlayerModal) {
  selectPlayerModal.classList.add('hidden');
}
  });
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      const addPlayerModal = document.getElementById('addPlayerModal');
      const selectPlayerModal = document.getElementById('selectPlayerModal');
      const adminHub = document.getElementById('adminHubModal');
      const savedPlayersAdmin = document.getElementById('savedPlayersAdminModal');
      if (addPlayerModal && !addPlayerModal.classList.contains('hidden')) addPlayerModal.classList.add('hidden');
      if (selectPlayerModal && !selectPlayerModal.classList.contains('hidden')) selectPlayerModal.classList.add('hidden');
      if (adminHub && !adminHub.classList.contains('hidden')) adminHub.classList.add('hidden');
      if (savedPlayersAdmin && !savedPlayersAdmin.classList.contains('hidden')) savedPlayersAdmin.classList.add('hidden');
    }
  });
});
</script>